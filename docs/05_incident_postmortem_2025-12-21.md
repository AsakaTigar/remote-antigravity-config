# 事故复盘：反向隧道 + 1080 代理链路失效

**事故时间**: 2025-12-21  
**影响范围**: VS Code Remote 代理失效  
**根本原因**: 代理架构设计不合理，链路过长导致脆弱性  
**解决方案**: 切换到 Mihomo TUN 模式

---

## 1. 事故现象

用户无法通过 VS Code Remote 正常访问外网，需要依赖本地 Windows 机器的反向 SSH 隧道：

```powershell
ssh -N -R 1080:127.0.0.1:<LOCAL_PORT> -p <SSH_PORT> <USER>@<SERVER_IP>
```

一旦反向隧道断开，远程服务器上的代理就会失效。

---

## 2. 原有架构分析

### 2.1 链路图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              原有链路（不推荐）                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌───────────┐ │
│  │ 远程 Linux   │    │   SSH 隧道   │    │ 本地 Windows │    │  互联网   │ │
│  │ 服务器       │───▶│ R 1080:63930 │───▶│ Clash 63930  │───▶│  目标站点 │ │
│  │              │    │              │    │              │    │           │ │
│  └──────────────┘    └──────────────┘    └──────────────┘    └───────────┘ │
│                                                                             │
│  依赖链: 应用 → http_proxy → 1080 → SSH隧道 → Windows Clash → 代理节点     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 架构缺陷

| 问题 | 说明 |
|------|------|
| **链路过长** | 5 个环节，任何一个断裂都会导致失败 |
| **依赖本地机器** | 本地 Windows 必须开着，SSH 连接必须保持 |
| **环境变量污染** | 需要在 `.bashrc` 设置 `http_proxy=127.0.0.1:1080` |
| **VS Code 配置残留** | `settings.json` 中硬编码了 `http.proxy: 127.0.0.1:1080` |
| **DNS 泄漏** | 部分应用可能绕过代理直接解析 DNS |
| **端口冲突** | 1080 端口已被多处使用，容易混乱 |

### 2.3 故障点分析

这次"事故"实际上不是代理坏了，而是：

1. **Mihomo TUN 已经在工作**，但用户不知道
2. **旧的反向隧道配置残留**让用户误以为还需要它
3. **心理依赖**：习惯了反向隧道，不敢关闭

---

## 3. 新架构

### 3.1 链路图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              新链路（推荐）                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────┐    ┌───────────┐                     │
│  │ 远程 Linux   │    │ Mihomo TUN   │    │  互联网   │                     │
│  │ 任何应用     │───▶│ 透明接管网络 │───▶│  目标站点 │                     │
│  │              │    │              │    │           │                     │
│  └──────────────┘    └──────────────┘    └───────────┘                     │
│                                                                             │
│  依赖链: 应用 → TUN 设备 → Mihomo → 代理节点                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 架构优势

| 优势 | 说明 |
|------|------|
| **链路极短** | 只有 3 个环节 |
| **完全独立** | 不依赖本地机器，服务器自给自足 |
| **无需环境变量** | TUN 透明接管，应用无感知 |
| **DNS 完全接管** | fake-ip 模式，杜绝 DNS 泄漏 |
| **开机自启** | systemd 服务自动管理 |

---

## 4. 经验教训

### 4.1 技术层面

1. **TUN 模式优于 SOCKS 代理**：透明接管比环境变量配置更可靠
2. **DNS 必须统一接管**：否则 `getaddrinfo ENOTFOUND` 问题无法根治
3. **配置残留是隐患**：旧配置不清理会导致行为不可预测

### 4.2 操作层面

1. **先诊断，后操作**：运行 `90_diagnose_proxy.sh` 确认状态
2. **一键修复优于手动**：`91_auto_fix.sh` 避免遗漏
3. **开机自检很重要**：`92_login_check.sh` 确保每次启动都正常

---

## 5. 后续行动

- [x] 安装登录自动检查服务
- [x] 清理 1080 端口配置残留
- [x] 关闭反向隧道，验证代理正常
- [x] 更新仓库文档
- [ ] 定期检查 Mihomo 订阅是否过期

---

## 6. 附录：当前状态

```
诊断时间: 2025-12-21 03:04
磁盘使用率: 39%
Mihomo PID: 1744951
TUN 设备: Meta
DNS 模式: fake-ip (198.18.x.x)
网络连接: 正常
反向隧道: 已关闭
```

**结论**：代理系统现在完全独立运行，不再依赖本地机器的反向隧道。
